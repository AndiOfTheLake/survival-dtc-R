## ---- pkg ----
library(survival)
library(survminer)


## ---- dt ----
data(GBSG2, package = "TH.data")
data(UnempDur, package = "Ecdat")

## ---- interp coef ----
dat <- structure(list(time = c(306, 455, 1010, 210, 883, 1022, 310, 
                               361, 218, 166, 170, 654, 728, 71, 567, 144, 613, 707, 61, 88, 
                               301, 81, 624, 371, 394, 520, 574, 118, 390, 12, 473, 26, 533, 
                               107, 53, 122, 814, 965, 93, 731, 460, 153, 433, 145, 583, 95, 
                               303, 519, 643, 765, 735, 189, 53, 246, 689, 65, 5, 132, 687, 
                               345, 444, 223, 175, 60, 163, 65, 208, 821, 428, 230, 840, 305, 
                               11, 132, 226, 426, 705, 363, 11, 176, 791, 95, 196, 167, 806, 
                               284, 641, 147, 740, 163, 655, 239, 88, 245, 588, 30, 179, 310, 
                               477, 166, 559, 450, 364, 107, 177, 156, 529, 11, 429, 351, 15, 
                               181, 283, 201, 524, 13, 212, 524, 288, 363, 442, 199, 550, 54, 
                               558, 207, 92, 60, 551, 543, 293, 202, 353, 511, 267, 511, 371, 
                               387, 457, 337, 201, 404, 222, 62, 458, 356, 353, 163, 31, 340, 
                               229, 444, 315, 182, 156, 329, 364, 291, 179, 376, 384, 268, 292, 
                               142, 413, 266, 194, 320, 181, 285, 301, 348, 197, 382, 303, 296, 
                               180, 186, 145, 269, 300, 284, 350, 272, 292, 332, 285, 259, 110, 
                               286, 270, 81, 131, 225, 269, 225, 243, 279, 276, 135, 79, 59, 
                               240, 202, 235, 105, 224, 239, 237, 173, 252, 221, 185, 92, 13, 
                               222, 192, 183, 211, 175, 197, 203, 116, 188, 191, 105, 174, 177
), status = c(2, 2, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 1, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 
              1, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 2, 1, 
              2, 2, 1, 1, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 1, 2, 2, 1, 1, 2, 1, 
              2, 1, 1, 2, 2, 2, 2, 1, 2, 2, 1, 1, 1, 2, 2, 2, 1, 1, 1, 2, 1, 
              1, 1, 2, 1, 2, 2, 2, 2, 2, 1, 2, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 
              2, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 
              1, 1), sex = structure(c(1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 1L, 
                                       1L, 1L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 2L, 1L, 1L, 1L, 
                                       2L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 
                                       2L, 2L, 2L, 1L, 2L, 1L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 2L, 
                                       1L, 2L, 2L, 2L, 1L, 1L, 2L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 2L, 1L, 
                                       1L, 2L, 2L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 2L, 1L, 2L, 
                                       1L, 1L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 1L, 1L, 1L, 
                                       1L, 2L, 1L, 1L, 2L, 1L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 
                                       2L, 2L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 1L, 1L, 2L, 1L, 2L, 2L, 
                                       1L, 1L, 1L, 2L, 1L, 1L, 2L, 1L, 2L, 1L, 1L, 1L, 2L, 1L, 1L, 2L, 
                                       2L, 1L, 1L, 2L, 1L, 1L, 2L, 2L, 2L, 1L, 1L, 1L, 2L, 2L, 1L, 1L, 
                                       1L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 2L, 2L, 1L, 1L, 2L, 2L, 2L, 
                                       2L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 2L, 1L, 2L, 
                                       1L, 2L, 2L, 2L, 1L, 2L, 2L, 1L, 2L, 2L, 1L, 1L, 2L, 1L, 1L, 2L, 
                                       1L, 2L, 2L, 1L, 2L, 1L, 1L, 1L, 2L, 1L, 2L), .Label = c("male", 
                                                                                               "female"), class = "factor")), row.names = c("1", "2", "3", "4", 
                                                                                                                                            "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", 
                                                                                                                                            "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", 
                                                                                                                                            "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", 
                                                                                                                                            "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", 
                                                                                                                                            "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", 
                                                                                                                                            "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", 
                                                                                                                                            "71", "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", 
                                                                                                                                            "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", 
                                                                                                                                            "93", "94", "95", "96", "97", "98", "99", "100", "101", "102", 
                                                                                                                                            "103", "104", "105", "106", "107", "108", "109", "110", "111", 
                                                                                                                                            "112", "113", "114", "115", "116", "117", "118", "119", "120", 
                                                                                                                                            "121", "122", "123", "124", "125", "126", "127", "128", "129", 
                                                                                                                                            "130", "131", "132", "133", "134", "135", "136", "137", "138", 
                                                                                                                                            "139", "140", "141", "142", "143", "144", "145", "146", "147", 
                                                                                                                                            "148", "149", "150", "151", "152", "153", "154", "155", "156", 
                                                                                                                                            "157", "158", "159", "160", "161", "162", "163", "164", "165", 
                                                                                                                                            "166", "167", "168", "169", "170", "171", "172", "173", "174", 
                                                                                                                                            "175", "176", "177", "178", "179", "180", "181", "182", "183", 
                                                                                                                                            "184", "185", "186", "187", "188", "189", "190", "191", "192", 
                                                                                                                                            "193", "194", "195", "196", "197", "198", "199", "200", "201", 
                                                                                                                                            "202", "203", "204", "205", "206", "207", "208", "209", "210", 
                                                                                                                                            "211", "212", "213", "214", "215", "216", "217", "218", "219", 
                                                                                                                                            "220", "221", "222", "223", "224", "225", "226", "227", "228"
                                                                                               ), class = "data.frame")

## ---- plot weibul ----
# step 1: 
# compute weibul model
wbmod <- survreg(Surv(time, cens) ~ horTh + tsize, data = GBSG2)

# Decide on covariate combinations (imaginary patients)
newdat <- expand.grid(horTh = levels(GBSG2$horTh),
                      tsize = quantile(GBSG2$tsize,
                                       probs = c(0.25, 0.5, 0.75))  )

newdat

# step 2: 
# compute survival curve
surv <- seq(.99, .01, by = -.01)
t <- predict(wbmod, type = "quantile", p = 1 - surv, newdata = newdat) 
dim(t)
t[, 1:7]

# Step 3:
# create a dataframe with survival curve information
surv_wbmod_wide <- cbind(newdat, t)
surv_wbmod_wide[, 1:7]

library("reshape2")
surv_wbmod <- melt(surv_wbmod_wide, 
                   id.vars = c("horTh", "tsize"),    
                   variable.name = "surv_id",  
                   value.name = "time")

dim(surv_wbmod)

head(surv_wbmod, 12)
tail(surv_wbmod, 12)

surv_wbmod$surv <- surv[as.numeric(surv_wbmod$surv_id)]

head(surv_wbmod)

surv_wbmod[, c("upper", "lower", "std.err", "strata")] <- NA

str(surv_wbmod)

# Step 4: plot

ggsurvplot_df(surv_wbmod, 
              surv.geom = geom_line,  
              linetype = "horTh", 
              color = "tsize", legend.title = NULL)

## ---- plot cox mod ----
cxmod <- coxph(Surv(time, cens) ~ horTh + tsize, data = GBSG2)

# Imaginary patients
newdat <- expand.grid(
  horTh = levels(GBSG2$horTh),
  tsize = quantile(GBSG2$tsize, probs = c(0.25, 0.5, 0.75)))
rownames(newdat) <- letters[1:6]

# explore newdat
newdat

# Compute survival curves
cxsf <- survfit(cxmod, data = GBSG2, newdata = newdat, conf.type = "none")

# look at he structure of cxsf
str(cxsf)

# Look at first 6 rows of cxsf$surv and time points
head(cxsf$surv)
head(cxsf$time)
cxsf

# Compute data.frame needed for plotting
surv_cxmod0 <- surv_summary(cxsf)
str(surv_cxmod0)
head(surv_cxmod0)
tail(surv_cxmod0)

# Get a character vector of patient letters (patient IDs)
pid <- as.character(surv_cxmod0$strata)
pid

# Multiple of the rows in newdat so that it fits with surv_cxmod0
m_newdat <- newdat[pid, ]
m_newdat
# Add patient info to data.frame
surv_cxmod <- cbind(surv_cxmod0, m_newdat)

# Plot
ggsurvplot_df(surv_cxmod, linetype = "horTh", color = "tsize",
              legend.title = NULL, censor = FALSE)

## ---- capstone ----

lung<-structure(list(time = c(306, 455, 1010, 210, 883, 1022, 310, 
                              361, 218, 166, 170, 654, 728, 71, 567, 144, 613, 707, 61, 88, 
                              301, 81, 624, 371, 394, 520, 574, 118, 390, 12, 473, 26, 533, 
                              107, 53, 122, 814, 965, 93, 731, 460, 153, 433, 145, 583, 95, 
                              303, 519, 643, 765, 735, 189, 53, 246, 689, 65, 5, 132, 687, 
                              345, 444, 223, 175, 60, 163, 65, 208, 821, 428, 230, 840, 305, 
                              11, 132, 226, 426, 705, 363, 11, 176, 791, 95, 196, 167, 806, 
                              284, 641, 147, 740, 163, 655, 239, 88, 245, 588, 30, 179, 310, 
                              477, 166, 559, 450, 364, 107, 177, 156, 529, 11, 429, 351, 15, 
                              181, 283, 201, 524, 13, 212, 524, 288, 363, 442, 199, 550, 54, 
                              558, 207, 92, 60, 551, 543, 293, 202, 353, 511, 267, 511, 371, 
                              387, 457, 337, 201, 404, 222, 62, 458, 356, 353, 163, 31, 340, 
                              229, 444, 315, 182, 156, 329, 364, 291, 179, 376, 384, 268, 292, 
                              142, 413, 266, 194, 320, 181, 285, 301, 348, 197, 382, 303, 296, 
                              180, 186, 145, 269, 300, 284, 350, 272, 292, 332, 285, 259, 110, 
                              286, 270, 81, 131, 225, 269, 225, 243, 279, 276, 135, 79, 59, 
                              240, 202, 235, 105, 224, 239, 237, 173, 252, 221, 185, 92, 13, 
                              222, 192, 183, 211, 175, 197, 203, 116, 188, 191, 105, 174, 177
), status = c(2, 2, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 1, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 
              1, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 1, 2, 1, 2, 2, 2, 2, 2, 1, 
              2, 2, 1, 1, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 1, 2, 2, 1, 1, 2, 1, 
              2, 1, 1, 2, 2, 2, 2, 1, 2, 2, 1, 1, 1, 2, 2, 2, 1, 1, 1, 2, 1, 
              1, 1, 2, 1, 2, 2, 2, 2, 2, 1, 2, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 
              2, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 
              1, 1), performance = c(90, 90, 90, 90, 100, 50, 70, 60, 70, 70, 
                                     80, 70, 90, 60, 80, 80, 90, 50, 60, 90, 80, 100, 70, 90, 90, 
                                     90, 100, 60, 80, 70, 90, 60, 60, 50, 70, 50, 70, 70, 50, 80, 
                                     80, 60, 90, 70, 60, 60, 90, 80, 90, 90, 90, 80, 90, 100, 90, 
                                     90, 100, 70, 80, 90, 70, 90, 80, 90, 80, 70, 70, 90, 100, 80, 
                                     90, 80, 70, 80, 90, 90, 100, 80, 90, 90, 100, 70, 80, 80, 80, 
                                     80, 80, 100, 90, 70, 100, 80, 90, 80, 100, 80, 80, 90, 90, 90, 
                                     100, 80, 70, 90, 50, 80, 80, 90, 100, 60, 90, 80, 80, 90, 80, 
                                     70, 70, 60, 70, 80, 90, 70, 70, 60, 90, 80, 80, 80, 80, 90, 80, 
                                     80, 100, 80, 90, 60, 80, 80, 90, 100, 70, 80, 70, 80, 80, 90, 
                                     100, 90, 100, 100, 70, 90, 90, 80, 70, 70, 90, 70, 80, 80, 90, 
                                     90, 60, 90, 80, 90, 80, 100, 90, 100, 90, 90, 90, 100, 90, 80, 
                                     60, 80, 80, 100, 100, 100, 90, 80, 90, 90, 70, 90, 80, 90, 80, 
                                     60, 90, 90, 90, 100, 80, 90, 100, 90, 90, 60, 90, 100, 100, NA, 
                                     80, 60, 80, 90, 100, 80, 90, 70, 80, 90, 90, 80, 70, 80, 80, 
                                     80, 80, 80, 90, 60, 90, 80)), class = "data.frame", row.names = c("1", 
                                                                                                       "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", 
                                                                                                       "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", 
                                                                                                       "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", 
                                                                                                       "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", 
                                                                                                       "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", 
                                                                                                       "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", 
                                                                                                       "69", "70", "71", "72", "73", "74", "75", "76", "77", "78", "79", 
                                                                                                       "80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", 
                                                                                                       "91", "92", "93", "94", "95", "96", "97", "98", "99", "100", 
                                                                                                       "101", "102", "103", "104", "105", "106", "107", "108", "109", 
                                                                                                       "110", "111", "112", "113", "114", "115", "116", "117", "118", 
                                                                                                       "119", "120", "121", "122", "123", "124", "125", "126", "127", 
                                                                                                       "128", "129", "130", "131", "132", "133", "134", "135", "136", 
                                                                                                       "137", "138", "139", "140", "141", "142", "143", "144", "145", 
                                                                                                       "146", "147", "148", "149", "150", "151", "152", "153", "154", 
                                                                                                       "155", "156", "157", "158", "159", "160", "161", "162", "163", 
                                                                                                       "164", "165", "166", "167", "168", "169", "170", "171", "172", 
                                                                                                       "173", "174", "175", "176", "177", "178", "179", "180", "181", 
                                                                                                       "182", "183", "184", "185", "186", "187", "188", "189", "190", 
                                                                                                       "191", "192", "193", "194", "195", "196", "197", "198", "199", 
                                                                                                       "200", "201", "202", "203", "204", "205", "206", "207", "208", 
                                                                                                       "209", "210", "211", "212", "213", "214", "215", "216", "217", 
                                                                                                       "218", "219", "220", "221", "222", "223", "224", "225", "226", 
                                                                                                       "227", "228"))
